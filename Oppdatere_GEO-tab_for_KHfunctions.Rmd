---
title: "Oppdatere GEO-tabellene i KHELSA.mdb"
author: "Steinar Bjørnæs"
date: '2022-10-26'
output: html_document
---

Det må fremdeles gjøres, for vi har data som ikke er GK-inndelt og ikke skal gjennom RDL.Dessuten brukes Geo-tabeller for å filtrere ut ugyldige etc.

# Metode:
For detaljer om Accesstabellene for KHfunctions, se Sharepoint: 
Folkehelseprofiler/Lukkede/Admin/Flytdiagram/Beskrivelse av oppgaver/Hva og hvor må gjøres ved Geo-endringer.docx

*Ta en backup av skarp database og les og skriv mot den. Erstatte filnavn for å gjøre den til skarp etter sjekking.*

For ID-felter (Autonummer i Access): La kolonnen mangle i datasettet ved skriving til Access, så oppretter Access selv nye ID-numre.


## Target:

### Tabell GeoKoder: Alle gyldige koder. 
ID	     GEO	NAVN	FRA	     TIL	GEOniv	TYP
3213	0101	Halden	1980	2019	K	    O
        (GEO er tekst, m. ledende nuller)  (Fra og til er tall)

Må lese inn gammel KHELSA-tabell, endre TIL-årstall for utgående koder, appende en preppet liste over nye koder, og erstatte hele den gamle tabellen med den nye, preppede.

- Årstall er styrende for databehandlingen. Første og siste år koden er gyldig.
- Utgående koder må få årstall TIL == siste år.
- Nye koder får årstall FRA == første år, TIL == 9999.
- K og B må ha to rader, en med sekssifret kode og GEOniv == S.
- Alle gyldige koder må stå her.


### Tabell KnrHarm: Alle omkodinger.
GEO	    GEO_omk	HARMstd
0101	3001	2020

- Årstall er bare til info, endringer slår inn straks.
- GEO er den utgåtte koden, GEO_omk er gyldig kode i produksjonsåret.
- Det er BARE gyldige koder i GEO_omk.
- Koder som utgår må altså flyttes fra GEO_omk til GEO.
- Ved sammenslåinger skal ALLE gamle koder i GEO, selv om koden gjenbrukes i GEO_omk.


## Kilde
Bruke de ferdige tabellene fra norgeo-systemet, STYRING/raw_khelse/geo-koder.accdb

### Gyldige koder: tblGeo.
Den har flg. struktur:

    code	name	               validTo  level	    grunnkrets	kommune	fylke	bydel	batch
03010101	Sentrum 1  - Rode 1	   2022	    grunnkrets	03010101	0301	03	    030116	19.09.2022
    0301	Oslo	               2022	    kommune		            0301	03		        19.09.2022

Altså: Komplett mapping fra en underliggende kode og oppover i geonivåene, for alle koder som 
er gyldige i året "ValidTo". OBS: Kode for hele landet mangler her.

Plukke fra denne tabellen alle "code" i level (L)FKB gyldige i angitt år.



```{r setup, include=FALSE}
# Chunk automatisk lagt inn av RStudio, men utvidet av meg
knitr::opts_chunk$set(echo = TRUE)

library(RODBC)         
library(orgdata)
library(haven)
library(tidyverse)
library(DBI)
library(odbc)

# CAVE: Rekkefølgen gjør at orgdata::read_file() og read_log() blir 'masked' av de tilsvarende readr-funksjonene. Må være eksplisitt om package hvis jeg skal bruke disse funksjonene.
```

```{r parametre}
aar    <- 2020                                      #Den nye Geo-årgangen
DBroot <- "F:/Forskningsprosjekter/PDB 2455 - Helseprofiler og til_/PRODUKSJON/STYRING"

# KH_db  <- "KHELSA.mdb"   #SKARP!
KH_db <- "VERSJONSARKIV/KHELSA201910030941.mdb"     #For utviklingen: Pre-2020-geo.

GEO_db <- "raw-khelse/geo-koder.accdb"              # Skal ikke skrive til denne.


#drv    <- "Driver={Microsoft Access Driver (*.mdb, *.accdb)};DBQ="

```

Koble til og lese fra kildetabellen:
Klarte ikke å få DBI-kommandoer til å fungere for tilkobling, så jeg bruker RODBC-kommandoer til å hente ut data.
SQL-query-teksten må ha tekstfnutter rundt 'aar', for aar er tekst i databasen ("ulike datatyper i uttrykket"). Om jeg hadde definert aar <- 2022  eller  aar <- "2022"  gjorde ingen forskjell.
Jeg leser inn alle gyldige koder, og filtrerer vekk ting etterpå.
    For 2022, 2023: 356 K + 11 F + 38 B (inkl Sentrum/Marka), + Uoppgitt: (1+11)K + 1F + 4B = 422 koder.

```{r connection og datainnlesing}
# Opprette forbindelse, "channel" i RODBC
kilde <- RODBC::odbcConnectAccess2007(paste(DBroot, GEO_db, sep = "/"))
target <- RODBC::odbcConnectAccess2007(paste(DBroot, KH_db, sep = "/"))

```


```{r testdata, eval = FALSE, include = FALSE}
# Testdata: Noen linjer med ulike verdier som input
DUMMYDATA <- readr::read_delim("F:\\Forskningsprosjekter\\PDB 2455 - Helseprofiler og til_\\PRODUKSJON\\TMP\\dummydata1.csv", 
                               delim = ";", col_types = "c")

kladd <- DUMMYDATA %>%
    mutate(GEO = dplyr::if_else(stringr::str_length(GEO) %in% c("3", "5", "7"),    #betingelse
                                paste("0", GEO, sep = ""),                         #hvis True
                                GEO))                                              #hvis False

```


# Tabell GeoKoder
```{r GeoKoder preppe ny input}
# Hente data
DATA <- RODBC::sqlQuery(kilde, paste("SELECT * FROM tblGeo WHERE validTo = ", "\'", aar, "\'", sep = ""))
old_GeoKoder <- sqlQuery(target, paste("SELECT * FROM GeoKoder"))   # Her blir GEO Integer, for å matche tblGeo.

# Filtrere fram gyldige koder som må ligge i target-tabellen GeoKoder
newtab <- DATA %>% 
    filter(level != "grunnkrets")

# Finne hvilke koder som må legges til (som ikke er inne fra før)
newtab <- dplyr::anti_join(newtab, old_GeoKoder, by = c("code" = "GEO"))

# Rense tabellen så strukturen matcher target
newtab <- newtab %>%
    dplyr::select(-grunnkrets, -kommune, -fylke, -bydel, -batch) %>% #fjerne kolonner
    dplyr::rename(NAVN = name) %>%                                   #nytt kolonnenavn
    dplyr::rename(FRA = validTo) %>%                                 #ditto, gyldighet av ny kode starter nå
    dplyr::mutate(TIL = 9999)                                        #ny kolonne med siste gyldighetsår

# Lage string geokoder
    # Legge til ledende null hvis geokoden er 3-5-7-sifret
newtab <- newtab %>%
    mutate(GEO = as.character(code)) %>%      # Oppretter ny chr-variabel GEO. Må slette 'code' senere.
    mutate(GEO = dplyr::if_else(stringr::str_length(GEO) %in% c("3", "5", "7"),    #betingelse
                                paste("0", GEO, sep = ""),                         #hvis True
                                GEO))                                              #hvis False

# Kode om fra string geonivå (level) til bokstavkoder (GEOniv)
newtab <- newtab %>%
    mutate(GEOniv = dplyr::case_when(level == "fylke" ~ "F",
                                     level == "kommune" ~ "K",
                                     level == "bydel" ~ "B",
                                     level == "grunnkrets" ~ "G"))
    
# Legge til dubletter med sekssifret sone-kode i GEO, og GEOniv == "S", for alle K og B
soner <- newtab %>%                                 # Kopierer ut K og B, og bygger om kopien til S
    filter(GEOniv %in% c("K", "B")) %>%
    mutate(GEO = dplyr::if_else(stringr::str_length(GEO) == 4,    #betingelse
                                paste(GEO, "00", sep = ""),       #hvis True
                                GEO))   %>%                       #hvis False
    mutate(GEOniv = "S")

newtab <- newtab %>%                                # Append nye S-koder til tabellen
    dplyr::bind_rows(soner)

# Opprette TYP lik O for normale og U for koder som ikke skal ut i kubene (for det meste 99-koder).
    # Søkestringer (pattern) i stringr tolkes som Regex. Skrives bare som string med quotes.
newtab <- newtab %>%
    mutate(TYP = "O") %>%
    mutate(TYP = dplyr::case_when(stringr::str_detect(GEO, ".99$") ~ "U",
                                  str_detect(GEO, ".9900$") ~ "U",
                                  .default = TYP))                  #hvis ingen ovenfor slår til

# Rydde og forberede datasettet for append til Accesstabellen
    # Trenger ingen ID-kolonne, den oppretter Access når jeg skriver til tabellen.
newtab <- newtab %>%
    dplyr::select(GEO, NAVN, FRA, TIL, GEOniv, TYP)        # Dette gir også rekkefølge av variablene.
    
```

```{r GeoKoder rense gammel tabell}
# Sette fjorårets årstall som TIL for utgående koder.
    # For å finne dem: Må lese i tabellene 'kommuneYYYY' og 'fylkeYYYY' for YYYY == <ny geo-årgang> (det finnes ingen 'bydelYYYY').
    # Filtrere fram bare changeOccurred == YYYY.
    # I GeoKoder filtrere fram bare gyldige koder (TIL == 9999).
    # De kodene som matcher mellom disse to listene, skal få TIL = YYYY.

    # OBS: Det finnes ingen 2020-tabeller i kildefilen GEO_koder.accdb, derfor trikses "2020" til å lese 2021-tabeller.

# Lese inn data og filtrere fram de relevante radene
    # Vi har (foreløpig) bare tabeller for Kommune og Fylke (og Grunnkrets) i norgeo-databasen GEO_koder.accdb.
    # KHELSA.mdb har 8-sifrede koder for Delbydel, som er kodet med GEOniv == "G" for å bli akseptert i KHfunctions,
old_GeoKoder <- sqlQuery(target, paste("SELECT * FROM GeoKoder"), as.is = TRUE)   # Her blir GEO bevart som string

ryddetOld <- old_GeoKoder %>%
    dplyr::filter(TIL == 9999)

```










### Omkodinger: kommune<åååå> etc.
(...)
